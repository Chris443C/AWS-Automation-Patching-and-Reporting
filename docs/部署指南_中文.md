# AWS 自动化补丁管理部署指南（中文版）

本指南为不熟悉 AWS 的用户提供简单易懂的部署步骤。

## 📋 部署前准备清单

### ✅ 必需项目
- [ ] AWS 账户（需要管理员权限）
- [ ] 电脑已安装 AWS CLI
- [ ] 电脑已安装 Python 3.8+
- [ ] 电脑已安装 PowerShell 5.1+
- [ ] 目标服务器已安装 AWS Systems Manager 代理

### 📝 需要准备的信息
- [ ] AWS 访问密钥 ID
- [ ] AWS 秘密访问密钥
- [ ] 通知邮箱地址
- [ ] 目标服务器实例 ID

## 🚀 第一步：环境准备

### 1.1 下载项目文件

**方法一：使用 Git（推荐）**
```bash
git clone https://github.com/your-org/aws-automation-patching-and-reporting.git
cd aws-automation-patching-and-reporting
```

**方法二：直接下载**
1. 访问项目 GitHub 页面
2. 点击 "Code" 按钮
3. 选择 "Download ZIP"
4. 解压到本地文件夹

### 1.2 安装 AWS CLI

**Windows 用户：**
1. 下载 AWS CLI 安装程序：https://awscli.amazonaws.com/AWSCLIV2.msi
2. 双击运行安装程序
3. 按照提示完成安装

**macOS 用户：**
```bash
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
```

**Linux 用户：**
```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

### 1.3 配置 AWS 凭据

打开命令行工具（PowerShell 或终端），运行：

```bash
aws configure
```

系统会提示您输入以下信息：

```
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name [None]: us-east-1
Default output format [None]: json
```

**如何获取 AWS 凭据：**
1. 登录 AWS 控制台
2. 点击右上角用户名
3. 选择 "Security credentials"
4. 在 "Access keys" 部分创建新的访问密钥

## 🛠️ 第二步：一键部署

### 2.1 使用自动部署脚本

在项目文件夹中打开 PowerShell，运行：

```powershell
# 开发环境部署
.\deploy.ps1 -Environment dev -NotificationEmail your-email@company.com

# 生产环境部署
.\deploy.ps1 -Environment prod -NotificationEmail admin@company.com -S3BucketName "my-company-patching-reports"
```

### 2.2 部署过程说明

部署脚本会自动执行以下操作：

1. **检查环境** ✅
   - 验证 AWS CLI 是否安装
   - 检查 AWS 凭据是否有效
   - 验证配置文件是否存在

2. **部署基础设施** 🏗️
   - 创建 S3 存储桶（存储报告）
   - 创建 Lambda 函数（自动化处理）
   - 创建 SNS 主题（发送通知）
   - 创建 EventBridge 规则（定时任务）

3. **配置 AWS Inspector** 🔍
   - 启用漏洞扫描
   - 设置扫描规则
   - 配置通知

4. **设置补丁管理器** 🔧
   - 创建补丁基线
   - 设置维护窗口
   - 配置审批工作流

### 2.3 部署成功标志

部署完成后，您会看到类似以下信息：

```
=== DEPLOYMENT COMPLETED ===
Next steps:
1. Configure target instances with Systems Manager agent
2. Tag instances with PatchGroup=dev-servers
3. Subscribe to SNS notifications
4. Test the automation with a manual patch scan
5. Review the deployment guide for detailed instructions
=============================
```

## 🖥️ 第三步：配置目标服务器

### 3.1 为服务器添加标签

**方法一：使用 AWS CLI**
```bash
aws ec2 create-tags --resources i-1234567890abcdef0 --tags Key=PatchGroup,Value=dev-servers
```

**方法二：使用 AWS 控制台**
1. 登录 AWS 控制台
2. 进入 EC2 服务
3. 选择目标实例
4. 点击 "Actions" → "Manage tags"
5. 添加标签：Key=PatchGroup, Value=dev-servers

### 3.2 检查 Systems Manager 代理

**Windows 服务器：**
```powershell
Get-Service -Name AmazonSSMAgent
```

**Linux 服务器：**
```bash
sudo systemctl status amazon-ssm-agent
```

**如果代理未运行，请安装：**

**Amazon Linux 2：**
```bash
sudo yum install -y amazon-ssm-agent
sudo systemctl enable amazon-ssm-agent
sudo systemctl start amazon-ssm-agent
```

**Ubuntu：**
```bash
sudo snap install amazon-ssm-agent --classic
sudo systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
sudo systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service
```

## 📧 第四步：配置通知

### 4.1 订阅 SNS 通知

1. 登录 AWS 控制台
2. 进入 SNS 服务
3. 找到名为 "PatchingApprovalNotifications-dev" 的主题
4. 点击主题名称
5. 点击 "Create subscription"
6. 选择协议：Email
7. 输入您的邮箱地址
8. 点击 "Create subscription"
9. 检查邮箱并确认订阅

### 4.2 测试通知

运行测试命令：
```bash
aws ssm send-command --instance-ids i-1234567890abcdef0 --document-name "AWS-RunPatchBaseline" --parameters '{"Operation":["Scan"]}'
```

## 🧪 第五步：测试系统

### 5.1 测试漏洞扫描

```bash
# 手动触发 Inspector 扫描
aws inspector2 start-scan --scan-type EC2 --resource-filter criteria='{"instanceTags":[{"key":"Environment","value":"dev"}]}'
```

### 5.2 测试补丁扫描

```bash
# 在目标服务器上运行补丁扫描
aws ssm send-command --instance-ids i-1234567890abcdef0 --document-name "AWS-RunPatchBaseline" --parameters '{"Operation":["Scan"]}'
```

### 5.3 测试审计脚本

```bash
# 运行系统审计脚本
aws ssm send-command --instance-ids i-1234567890abcdef0 --document-name "SystemAuditScript" --parameters '{"OutputPath":["C:\\temp\\test-audit.json"]}'
```

## 📊 第六步：查看结果

### 6.1 查看 CloudWatch 仪表板

1. 登录 AWS 控制台
2. 进入 CloudWatch 服务
3. 点击 "Dashboards"
4. 找到 "PatchingAutomation-dev" 仪表板
5. 查看各种指标和日志

### 6.2 查看 S3 报告

1. 登录 AWS 控制台
2. 进入 S3 服务
3. 找到您的报告存储桶
4. 浏览以下文件夹：
   - `inspector-findings/` - 漏洞扫描结果
   - `patch-compliance/` - 补丁合规报告
   - `patch-approvals/` - 补丁审批记录

### 6.3 查看 Systems Manager 合规性

1. 登录 AWS 控制台
2. 进入 Systems Manager 服务
3. 点击 "Compliance"
4. 查看补丁合规性状态

## 🔧 常见问题解决

### 问题 1：部署脚本失败

**错误信息：** "AWS CLI not found"
**解决方案：**
1. 重新安装 AWS CLI
2. 重启命令行工具
3. 检查 PATH 环境变量

**错误信息：** "AWS credentials not configured"
**解决方案：**
1. 运行 `aws configure` 重新配置
2. 检查访问密钥是否正确
3. 确认密钥有足够权限

### 问题 2：服务器无响应

**错误信息：** "Instance is not responding"
**解决方案：**
1. 检查 Systems Manager 代理是否运行
2. 确认服务器 IAM 角色包含必要权限
3. 检查网络连接

### 问题 3：补丁扫描失败

**错误信息：** "Patch baseline not found"
**解决方案：**
1. 确认补丁基线已创建
2. 检查服务器标签是否正确
3. 验证操作系统类型匹配

## 📈 监控和维护

### 日常监控任务

1. **每日检查**
   - 查看 SNS 通知邮件
   - 检查 CloudWatch 仪表板
   - 查看补丁合规状态

2. **每周检查**
   - 审查补丁审批历史
   - 查看漏洞扫描报告
   - 检查系统性能指标

3. **每月检查**
   - 审查安全配置
   - 更新补丁基线
   - 优化自动化规则

### 成本优化建议

1. **S3 存储优化**
   - 设置生命周期策略删除旧报告
   - 使用 S3 智能分层

2. **Lambda 优化**
   - 监控函数执行时间
   - 优化代码减少执行时间

3. **Inspector 优化**
   - 根据需求调整扫描频率
   - 只扫描必要的资源

## 🎯 最佳实践

### 安全最佳实践

1. **最小权限原则**
   - 只给必要的权限
   - 定期审查 IAM 角色

2. **加密保护**
   - 确保数据加密存储
   - 使用 HTTPS 传输

3. **审计日志**
   - 启用 CloudTrail 日志
   - 定期审查访问记录

### 操作最佳实践

1. **测试环境先行**
   - 先在开发环境测试
   - 验证补丁兼容性

2. **变更管理**
   - 记录所有变更
   - 使用版本控制

3. **备份策略**
   - 定期备份配置
   - 测试恢复流程

## 📞 获取帮助

### 技术支持

1. **查看日志**
   - CloudWatch 日志
   - Lambda 函数日志
   - Systems Manager 日志

2. **常见问题**
   - 查看故障排除指南
   - 搜索 GitHub Issues

3. **联系支持**
   - 创建 GitHub Issue
   - 联系 AWS 支持

### 学习资源

1. **AWS 文档**
   - Systems Manager 文档
   - Inspector 文档
   - CloudFormation 文档

2. **视频教程**
   - AWS 官方视频
   - 社区教程

3. **实践练习**
   - AWS 免费套餐
   - 沙盒环境 