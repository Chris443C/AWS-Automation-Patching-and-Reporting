# 🔧 故障排除指南（中文版）

本指南帮助您解决 AWS 自动化补丁管理系统中的常见问题。

## 🚨 紧急问题

### 问题：系统完全无法工作
**症状：** 没有任何通知，无法访问 AWS 服务

**快速解决方案：**
1. 检查网络连接
2. 确认 AWS 账户状态
3. 验证 AWS 凭据是否过期

**详细步骤：**
```bash
# 检查 AWS 凭据
aws sts get-caller-identity

# 检查网络连接
ping aws.amazon.com
```

---

## 📋 常见问题分类

### 🔑 认证和权限问题

#### 问题 1：AWS CLI 未找到
**错误信息：** `'aws' is not recognized as an internal or external command`

**解决方案：**
1. **重新安装 AWS CLI**
   - Windows: 下载并运行 https://awscli.amazonaws.com/AWSCLIV2.msi
   - macOS: `curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg" && sudo installer -pkg AWSCLIV2.pkg -target /`
   - Linux: `curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && sudo ./aws/install`

2. **重启命令行工具**
3. **检查 PATH 环境变量**

#### 问题 2：AWS 凭据无效
**错误信息：** `Unable to locate credentials` 或 `Invalid credentials`

**解决方案：**
```bash
# 重新配置凭据
aws configure

# 输入正确的信息：
# AWS Access Key ID: [您的访问密钥]
# AWS Secret Access Key: [您的秘密密钥]
# Default region: us-east-1
# Default output format: json
```

**如何获取新的访问密钥：**
1. 登录 AWS 控制台
2. 点击右上角用户名
3. 选择 "Security credentials"
4. 在 "Access keys" 部分创建新的访问密钥

#### 问题 3：权限不足
**错误信息：** `Access Denied` 或 `Insufficient permissions`

**解决方案：**
1. 确认用户有管理员权限
2. 检查 IAM 策略是否包含必要权限
3. 联系 AWS 管理员获取适当权限

---

### 🖥️ 服务器连接问题

#### 问题 4：服务器无响应
**错误信息：** `Instance is not responding` 或 `Connection timeout`

**解决方案：**

**检查 Systems Manager 代理：**
```powershell
# Windows 服务器
Get-Service -Name AmazonSSMAgent

# Linux 服务器
sudo systemctl status amazon-ssm-agent
```

**如果代理未运行，请安装：**

**Amazon Linux 2：**
```bash
sudo yum install -y amazon-ssm-agent
sudo systemctl enable amazon-ssm-agent
sudo systemctl start amazon-ssm-agent
```

**Ubuntu：**
```bash
sudo snap install amazon-ssm-agent --classic
sudo systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
sudo systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service
```

**Windows：**
1. 下载代理：https://s3.amazonaws.com/amazon-ssm-region/latest/windows_amd64/AmazonSSMAgentSetup.exe
2. 运行安装程序
3. 重启服务：`Restart-Service AmazonSSMAgent`

#### 问题 5：IAM 角色权限不足
**错误信息：** `The instance profile associated with the instance does not have the required permissions`

**解决方案：**
1. 为服务器实例添加 IAM 角色
2. 确保角色包含以下策略：
   - `AmazonSSMManagedInstanceCore`
   - `CloudWatchAgentServerPolicy`（可选）

**添加 IAM 角色：**
1. 登录 AWS 控制台
2. 进入 EC2 服务
3. 选择目标实例
4. 点击 "Actions" → "Security" → "Modify IAM role"
5. 选择适当的角色

---

### 🔧 补丁管理问题

#### 问题 6：补丁基线未找到
**错误信息：** `Patch baseline not found` 或 `No patch baseline associated`

**解决方案：**
```bash
# 列出可用的补丁基线
aws ssm describe-patch-baselines

# 验证基线关联
aws ssm describe-patch-groups
```

**手动创建补丁基线：**
1. 登录 AWS 控制台
2. 进入 Systems Manager 服务
3. 点击 "Patch Manager"
4. 点击 "Create patch baseline"
5. 配置基线设置

#### 问题 7：补丁扫描失败
**错误信息：** `Patch scan failed` 或 `No patches available`

**解决方案：**
1. 检查服务器标签是否正确
2. 确认操作系统类型匹配
3. 验证网络连接

**检查服务器标签：**
```bash
# 查看实例标签
aws ec2 describe-instances --instance-ids i-1234567890abcdef0 --query 'Reservations[].Instances[].Tags'

# 添加正确的标签
aws ec2 create-tags --resources i-1234567890abcdef0 --tags Key=PatchGroup,Value=dev-servers
```

#### 问题 8：补丁安装失败
**错误信息：** `Patch installation failed` 或 `Reboot required`

**解决方案：**
1. 检查服务器是否有足够的磁盘空间
2. 确认服务器可以重启
3. 查看详细的错误日志

**检查磁盘空间：**
```bash
# Linux
df -h

# Windows PowerShell
Get-WmiObject -Class Win32_LogicalDisk | Select-Object DeviceID, Size, FreeSpace
```

---

### 📧 通知问题

#### 问题 9：没有收到邮件通知
**症状：** 系统运行正常，但没有收到任何邮件

**解决方案：**

**检查 SNS 订阅状态：**
1. 登录 AWS 控制台
2. 进入 SNS 服务
3. 找到主题：`PatchingApprovalNotifications-dev`
4. 检查订阅状态是否为 "Confirmed"

**重新订阅：**
1. 删除现有订阅
2. 创建新订阅
3. 检查邮箱并确认订阅

**检查垃圾邮件文件夹：**
- 查看邮箱的垃圾邮件文件夹
- 将 AWS 邮件地址添加到白名单

#### 问题 10：邮件内容不完整
**症状：** 收到邮件但信息不完整

**解决方案：**
1. 检查邮件客户端设置
2. 尝试使用不同的邮件客户端
3. 查看 S3 中的完整报告

---

### 📊 报告和监控问题

#### 问题 11：无法查看 CloudWatch 仪表板
**错误信息：** `Dashboard not found` 或 `Access denied`

**解决方案：**
1. 确认 CloudWatch 权限
2. 检查仪表板名称是否正确
3. 验证区域设置

**查看仪表板：**
1. 登录 AWS 控制台
2. 进入 CloudWatch 服务
3. 点击 "Dashboards"
4. 查找 "PatchingAutomation-dev"

#### 问题 12：S3 报告无法访问
**错误信息：** `Access denied` 或 `Bucket not found`

**解决方案：**
1. 检查 S3 存储桶权限
2. 确认存储桶名称正确
3. 验证区域设置

**查看报告：**
1. 登录 AWS 控制台
2. 进入 S3 服务
3. 找到您的报告存储桶
4. 浏览文件夹查看报告

---

### 🔍 Lambda 函数问题

#### 问题 13：Lambda 函数错误
**错误信息：** `Lambda function error` 或 `Function timeout`

**解决方案：**

**查看 Lambda 日志：**
```bash
# 列出日志组
aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/PatchingAutomation"

# 查看最近的日志
aws logs filter-log-events --log-group-name "/aws/lambda/PatchingAutomationLambdaRole-dev" --start-time $(date -d '1 hour ago' +%s)000
```

**检查 Lambda 函数状态：**
1. 登录 AWS 控制台
2. 进入 Lambda 服务
3. 查找相关函数
4. 检查函数配置和权限

---

## 🛠️ 诊断工具

### 系统健康检查脚本
```bash
#!/bin/bash
echo "=== AWS 自动化补丁管理系统健康检查 ==="

# 检查 AWS CLI
echo "1. 检查 AWS CLI..."
if command -v aws &> /dev/null; then
    echo "✓ AWS CLI 已安装"
    aws --version
else
    echo "✗ AWS CLI 未安装"
fi

# 检查 AWS 凭据
echo "2. 检查 AWS 凭据..."
aws sts get-caller-identity

# 检查 Systems Manager 代理
echo "3. 检查 Systems Manager 代理..."
if systemctl is-active --quiet amazon-ssm-agent; then
    echo "✓ SSM 代理正在运行"
else
    echo "✗ SSM 代理未运行"
fi

# 检查补丁基线
echo "4. 检查补丁基线..."
aws ssm describe-patch-baselines

echo "=== 健康检查完成 ==="
```

### 快速修复命令
```bash
# 重启 Systems Manager 代理
sudo systemctl restart amazon-ssm-agent

# 重新配置 AWS 凭据
aws configure

# 测试补丁扫描
aws ssm send-command --instance-ids i-1234567890abcdef0 --document-name "AWS-RunPatchBaseline" --parameters '{"Operation":["Scan"]}'

# 查看最近的日志
aws logs filter-log-events --log-group-name "/aws/lambda/PatchingAutomationLambdaRole-dev" --start-time $(date -d '1 hour ago' +%s)000
```

---

## 📞 获取帮助

### 自助解决
1. **查看日志**：CloudWatch → Log groups
2. **检查状态**：Systems Manager → Compliance
3. **查看报告**：S3 → 您的存储桶

### 联系支持
1. **创建 GitHub Issue**：描述问题和错误信息
2. **联系 AWS 支持**：如果是 AWS 服务问题
3. **查看 AWS 文档**：Systems Manager、Inspector 等

### 有用的链接
- [AWS Systems Manager 文档](https://docs.aws.amazon.com/systems-manager/)
- [AWS Inspector 文档](https://docs.aws.amazon.com/inspector/)
- [AWS CLI 文档](https://docs.aws.amazon.com/cli/)

---

## 🎯 预防措施

### 定期维护
1. **每周检查**：补丁合规状态
2. **每月审查**：安全配置
3. **每季度更新**：补丁基线

### 监控建议
1. **设置 CloudWatch 告警**
2. **定期查看 S3 报告**
3. **监控 AWS 成本**

### 备份策略
1. **定期备份配置文件**
2. **导出重要设置**
3. **记录变更历史**

---

## ✅ 问题解决检查清单

在联系支持之前，请确认：

- [ ] 已检查 AWS CLI 是否安装
- [ ] 已验证 AWS 凭据是否有效
- [ ] 已确认服务器标签是否正确
- [ ] 已检查 Systems Manager 代理状态
- [ ] 已查看 CloudWatch 日志
- [ ] 已尝试重启相关服务
- [ ] 已检查网络连接
- [ ] 已确认权限设置

如果以上步骤都无法解决问题，请提供以下信息：
1. 错误信息的完整文本
2. 系统配置信息
3. 操作步骤的详细描述
4. 相关的日志文件 